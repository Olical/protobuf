<project name="clojure-protobuf" default="package">

  <property name="repository.protobuf" value="http://protobuf.googlecode.com/files"/>
  <property name="dep.protobuf" value="protobuf-2.3.0"/>
 
  <target name="init">
    <mkdir dir="lib"/>
    <mkdir dir="classes"/>
  </target>

  <target name="distclean" depends="clean">
    <delete dir="lib"/>
  </target>

  <target name="clean">
    <delete>
      <fileset dir="." includes="*.jar"/>
    </delete>
    <delete dir="classes"/>
  </target>

  <available file="lib/${dep.protobuf}" property="protobuf.present"/>
  <target name="protobuf.fetch" depends="init" unless="protobuf.present">
    <get src="${repository.protobuf}/${dep.protobuf}.tar.gz"
         dest="lib/${dep.protobuf}.tar.gz" usetimestamp="true"/>
    <gunzip src="lib/${dep.protobuf}.tar.gz"/>
    <untar src="lib/${dep.protobuf}.tar" dest="lib"/>
    <delete file="lib/${dep.protobuf}.tar"/>
    <chmod file="lib/${dep.protobuf}/configure" perm="+x"/>
  </target>

  <available file="lib/${dep.protobuf}/Makefile" property="protobuf.makefile.present"/>
  <target name="protobuf.configure" depends="protobuf.fetch" unless="protobuf.makefile.present">
    <exec dir="lib/${dep.protobuf}" executable="./configure"/>
  </target>

  <path id="classpath">
    <fileset dir="${user.home}/lib/java" includes="*.jar"/>
    <pathelement location="${clojure_jar}"/>
    <pathelement location="src/clj"/>
    <pathelement location="classes"/>
  </path>

  <target name="protobuf.make" depends="protobuf.configure">
    <exec dir="lib/${dep.protobuf}" executable="make"/>
    <exec dir="lib/${dep.protobuf}/java" executable="../src/protoc">
      <arg value="--java_out=src/main/java"/>
      <arg value="-I../src"/>
      <arg value="../src/google/protobuf/descriptor.proto"/>
    </exec>
    <javac srcdir="lib/${dep.protobuf}/java/src/main/java" destdir="classes"/>
  </target>

  <target name="compile" depends="protobuf.make">
    <javac srcdir="src/jvm" destdir="classes" classpathref="classpath"/>
    <java classname="clojure.lang.Compile" classpathref="classpath">
      <sysproperty key="clojure.compile.path" value="classes"/>
      <arg value="protobuf"/>
    </java>
  </target>

  <target name="package" depends="compile">
    <jar destfile="clojure-protobuf.jar" basedir="classes"/>
  </target>

</project>
